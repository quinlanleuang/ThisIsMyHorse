### 事务隔离

- 事务支持是在存储引擎实现的，并不是所有的存储引擎都支持事务

- 隔离型和隔离级别

  ```
  1. ACID（Atomicity、Consistency、Isolation、Durability）原子性、一致性、隔离性、持久性
  2. 脏读、不可重复读、幻读
  3. 事务隔离级别，隔离得越严，效率越低：读未提交、读提交、可重复读和串行化
  4. 读未提交：一个事务还没有提交，它所做的变更就能被其他事务看到
  5. 读提交：一个事务提交之后，它所做的变更才能被其他事务看到
  6. 可重复读：一个事务执行过程中看到的数据，和它启动时看到的数据一致
  7. 串行化：对于同一行记录，读加读锁，写加写锁。当出现读写锁冲突时，后访问的事务等先访问的事务执行完，才能继续执行
  8. show variables like 'transaction_isolation';
  ```

- 事务隔离级别的实现

  ```
  1. 每条记录在更新时都会记录一条回滚操作，1->2->3->4，此时不同时刻启动的事务看到的记录值不同。
  2. 数据库的多版本并发控制（MVCC）：同一条记录在系统中可以存在多个版本，旧版本的值时由当前值通过一系列回滚操作得到
  3. 当系统判定没有比这个回滚日志更早的read-view时，才会删除回滚日志
  4. set autocommit=1设置事务的自动提交
  5. 
  ```

- 事务的使用

  ```
  1. begin或者start transaction 开启事务
  2. commit	提交事务
  3. rollback 回滚事务
  4. commit work and chain 提交事务并自动启动下一个事务，省去了再次执行begin的开销
  ```

- 课后练习

  ```
  Q: 什么时候需要“可重复读”的场景呢？
  A: 对账时，一个表存余额，一个表存账单明细。在校对过程中，希望有用户发生一笔交易时不影响校对的结果。
  
  Q: 为什么尽量不要使用长事务
  A: 1.长事务有可能会访问一些老的事务视图，因此，在事务提交之前，这些老的事务视图的回滚日志都必须保留，这回导致占用很大的存储空间；2. 长事务占用锁资源
  
  Q: 如何避免长事务情况的出现或者如何处理这种情况？
  A: 
  应用开发端：
	1. 确认是否使用了set autocommit=0。在测试环境将M有SQL的general_log开起来观察
  	2. 去掉不必要的只读事务（事务中所有的语句都是select）
  	3. 通过SET MAX_EXECUTION_TIME命令控制每个语句的最大执行时间
  数据库端：
  	1. 监控information_schema.Innodb_trx表，设置长事务阈值，超过则报警或者kill掉
  	2. Percona的pt-kill
  	3. 分析general_log日志行为
  	4. MySQL5.6+版本，可设置innodb_undo_tablespaces=2，如果出现大事务导致回滚过大，这样设置后清理起来更方便
  
  Q: 为什么要重建索引？
  A: 索引可能因为删除，或者页分裂等原因，导致页有空洞
  
  Q: 重建二级索引与重建主键索引（重建=现drop后add）
  A: 重建二级索引可以省空间，重建主键索引不正确，正确的使用方式是alter table T engine=innodb
  ```
  

- 如果我执行 select * from T where k between 3 and 5，需要执行几次树的搜索操作，会扫描多少行？ 3+2=5

  ![](https://static001.geekbang.org/resource/image/dc/8d/dcda101051f28502bd5c4402b292e38d.png)

### 覆盖索引

- select ID from T where k between 3 and 5，所需要查询的数据在二级索引树里全都能找到，不需要回表，称之为覆盖索引
- 在一个市民信息表上，是否有必要将身份证号和名字建立联合索引？在建立冗余索引支持覆盖索引时需要权衡考虑

### 最左前缀原则

- 当查询条件匹配联合索引的最左N个字段，或者字符串索引的最左M个字符，能够使用索引

### 索引下推

- 对于不符合索引最左匹配的部分，我们需要回表操作来判断数据是否符合条件

- 在MySQL5.6之前，满足最左匹配部分的数据都需要进行回表操作

- 在MySQL5.6之后，由于索引条件下推，在回表之前就可以将不等于右边部分的数据给过滤掉，减少了回表的次数

  ![](https://static001.geekbang.org/resource/image/b3/ac/b32aa8b1f75611e0759e52f5915539ac.jpg)

  ![](https://static001.geekbang.org/resource/image/76/1b/76e385f3df5a694cc4238c7b65acfe1b.jpg)