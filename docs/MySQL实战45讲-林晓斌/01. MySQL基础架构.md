# MySQL基础架构-一条查询语句的执行过程

- Server层

  - 连接器，负责与client建立连接，获取权限，维持和管理连接

    ```
    1. mysql -h $ip -P $port -u $user -p
    2. 连接建立之后，获取到的权限将不会有所改变，即使使用期间对用户的权限做了修改
    3. show processlist 可查看当前所有的连接
    4. 如果连接闲置时间大于wait_timeout,连接器会自动断开此连接
    5. 连接过程：三次握手->认证身份->获取权限
    6. 尽量避免建立连接的操作，尽可能地使用长连接
    7. 连接对象管理着MySQL执行过程中使用的临时对象，当使用长连接时，MySQL内存涨得特别快。解决方式：一是定期断开长连接，使用时再重连；二是MySQL5.7之后的版本，可通过执行mysql_reset_connection来重置连接，该操作不需要重连即可恢复到连接刚刚创建完成时
    ```

  - 查询缓存

    ```
    1. key=查询语句，value=查询结果
    2. 尽量避免使用，当一个表频繁更新时，这个表的查询缓存频繁失效，弊大于利
    3. 设置参数query_cache_type=DEMAND，可以按需使用查询缓存，默认的SQL语句不使用查询缓存，使用SQL_CACHE显式指定时使用查询缓存。
    > select SQL_CACHE * FROM T WHERE ID=10;
    4. MySQL8.0版本之后，不在支持查询缓存功能
    ```

  - 分析器

    ```
    1. 目的是让MySQL知道要做什么事
    2. 词法分析，将每一个出现的词识别为其对应的含义，比如select=查询，T=表T，ID=列ID等等
    3. 语法分析，根据语法规则，检测SQL语句是否满足MySQL语法
    4. 语法错误会提示第一个出现错误的位置，即'use near'之后的内容
    ```

  - 优化器

    ```
    1. 目的是让MySQL确定事情怎么做，比如使用哪个索引，join时表的连接顺序等
    ```

  - 执行器

    ```
    1. 先判断该连接是否有操作权限
    2. 如果有操作权限，执行器根据表的引擎定义，去调用该引擎提供的接口
    3. rows_examined表示调用引擎接口的次数，而一次引擎调用内部可能会扫描多行
    ```

- 存储引擎层，负责数据的存储和提取

<img src="https://static001.geekbang.org/resource/image/0d/d9/0d2070e8f84c4801adbfa03bda1f98d9.png" alt="image" style="zoom:30%;" />

- 课后联系

  ```
  Q: 如果表 T 中没有字段 k，而你执行了这个语句 select * from T where k=1, 那肯定是会报“不存在这个列”的错误： “Unknown column ‘k’ in ‘where clause’”。你觉得这个错误是在我们上面提到的哪个阶段报出来的呢？
  A: 分析器，在确定“做什么”的阶段就能判定可行性
  ```

  